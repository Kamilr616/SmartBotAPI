@page "/measurement-charts"
@inject MeasurementService MeasurementService
@using MudBlazor
@using SmartBotBlazorApp.Data
@using System.Linq


@* TODO: apply CSS ! and repair button*@
<MudButton OnClick="LoadMeasurements">Załaduj dane z bazy</MudButton>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudChart ChartType="ChartType.Line" ChartSeries="@_seriesT" XAxisLabels="@chartLabels" Title="Temperatura" />
    <MudChart ChartType="ChartType.Line" ChartSeries="@_seriesD" XAxisLabels="@chartLabels" Title="Średnia odległość" />
    <MudChart ChartType="ChartType.Line" ChartSeries="@_seriesA" XAxisLabels="@chartLabels" Title="Przyspieszenie" />
    <MudChart ChartType="ChartType.Line" ChartSeries="@_seriesR" XAxisLabels="@chartLabels" Title="Rotacja" />
}

@if (!isLoading && !string.IsNullOrEmpty(errorMessage))
{
    <MudText Typo="Typo.h6" Color="Color.Error">@errorMessage</MudText>
}

@code {
    private string[] chartLabels;

    private readonly List<ChartSeries> _seriesA = new();
    private readonly List<ChartSeries> _seriesD = new();
    private readonly List<ChartSeries> _seriesR = new();
    private readonly List<ChartSeries> _seriesT = new();

    private DateTime fromDateT = DateTime.Parse("2024-12-08 15:25:30"); //TODO: get datetime form input
    private DateTime toDateT = DateTime.Parse("2024-12-08 15:27:00");

    private bool isLoading = false;
    private bool isDataLoaded = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadMeasurements();
    }

    private async Task LoadMeasurements()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;

            // Pobierz dane z bazy
            var measurements = await MeasurementService.GetMeasurementsFromDatabaseAsync(fromDateT, toDateT); 
            if (measurements != null && measurements.Any())
            {
                // Przygotowanie etykiet wykresów 
                chartLabels = measurements.Select(m => m.Timestamp.ToShortTimeString()).ToArray();

                _seriesT.Add(new ChartSeries { Name = "C", Data = measurements.Select(m => m.TemperatureC).ToArray() });

                _seriesD.Add(new ChartSeries { Name = "mm", Data = measurements.Select(m => (double)m.AvgDistance).ToArray() });

                _seriesA.Add(new ChartSeries { Name = "X", Data = measurements.Select(m => m.AccelerationX).ToArray() });
                _seriesA.Add(new ChartSeries { Name = "Y", Data = measurements.Select(m => m.AccelerationY).ToArray() });
                _seriesA.Add(new ChartSeries { Name = "Z", Data = measurements.Select(m => m.AccelerationZ).ToArray() });

                _seriesR.Add(new ChartSeries { Name = "X", Data = measurements.Select(m => m.RotationX).ToArray() });
                _seriesR.Add(new ChartSeries { Name = "Y", Data = measurements.Select(m => m.RotationY).ToArray() });
                _seriesR.Add(new ChartSeries { Name = "Z", Data = measurements.Select(m => m.RotationZ).ToArray() });

                isDataLoaded = true;
            }
            else
            {
                errorMessage = "Brak danych do wyświetlenia.";
                isDataLoaded = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Wystąpił błąd: {ex.Message}";
            isDataLoaded = false;
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);

        }
    }
}
